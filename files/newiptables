#!/bin/bash
#####################
# Managed by Puppet #
#####################
## check and load iptables source
## no automatic saving here
## Sergio.Ballestrero@gmail.com, started around 2006

SRC=${1:-/etc/sysconfig/iptables.source}
FAIL=/var/run/iptables.failed
# prepare the file with the right SELinux context
echo ""> $FAIL
chcon -t iptables_var_run_t $FAIL

## these may be generated by the ruby functions of the atlasgw firewall
echo "# check for errors in the iptables.source generation"
if grep -q "ERROR:" $SRC ; then
    grep "ERROR:" $SRC >> $FAIL
    exit 1
fi

echo "# test loading $SRC"
if ! /sbin/iptables-restore --test $SRC ; then
    /sbin/iptables-restore --test $SRC >> $FAIL 2>&1
    exit 1
fi
echo "# loading $SRC"
if ! /sbin/iptables-restore $SRC ; then
    /sbin/iptables-restore $SRC >> $FAIL 2>&1
    exit 1
fi
rm -f $FAIL
echo "run 'service iptables save' to make the change permananent"
